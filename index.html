<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAF - Universidad de La Sabana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .click-scale:active { transform: scale(0.95); transition: transform 0.1s; }

        /* Colores Institucionales */
        .bg-caf-blue { background-color: #002855; }
        .text-caf-blue { color: #002855; }
        .bg-caf-accent { background-color: #E63946; }
        
        /* Locker & Cards */
        .locker-card { transition: all 0.3s ease; }
        .locker-card.assigned { background-color: #dcfce7; border: 2px solid #22c55e; }
        
        /* Inputs para entrenamiento */
        .workout-input {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            width: 100%;
            font-weight: bold;
            color: #002855;
        }
        .workout-input:focus {
            outline: none;
            border-color: #002855;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="h-screen flex justify-center overflow-hidden">

    <div class="w-full max-w-md h-full bg-gray-50 relative shadow-2xl flex flex-col overflow-hidden">
        
        <!-- HEADER -->
        <div class="bg-caf-blue text-white pt-12 pb-6 px-6 rounded-b-3xl shadow-lg z-10 shrink-0 transition-all duration-300" id="mainHeader">
            <div class="flex justify-between items-center mb-4">
                <div id="backButton" class="hidden cursor-pointer w-8 h-8 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/20 transition" onclick="goBack()">
                    <i class="fas fa-arrow-left text-sm"></i>
                </div>
                <div class="flex-1 text-center font-bold text-lg tracking-wide truncate px-2" id="headerTitle">Bienvenido al CAF</div>
                <div class="w-8"></div> <!-- Espaciador -->
            </div>
            
            <div class="flex items-center justify-between" id="profileHeader">
                <div class="flex items-center gap-3 bg-white/10 py-2 px-4 rounded-full backdrop-blur-sm">
                    <i class="fas fa-user-circle text-2xl text-gray-200"></i>
                    <span class="font-semibold text-sm">Juan Pablo</span>
                </div>
                <div class="text-xs text-gray-300 font-light" id="currentDate">Martes, 15 de Abril</div>
            </div>
        </div>

        <!-- CONTENIDO -->
        <div class="flex-1 overflow-y-auto pb-24" id="mainContent">
            
            <!-- VISTA 1: HOME -->
            <div id="view-home" class="p-6 space-y-5 fade-in">
                <!-- Training Log Card -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden relative click-scale cursor-pointer group" onclick="navigateTo('training')">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60')] bg-cover bg-center opacity-20 group-hover:opacity-30 transition"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-caf-blue/90 to-caf-blue/70"></div>
                    <div class="relative p-6 text-white">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-dumbbell text-red-400 text-xl"></i>
                            <h3 class="font-bold text-xl">Entrenamiento</h3>
                        </div>
                        <p class="text-sm text-gray-200 mb-4">Registra tus rutinas y monitorea cargas.</p>
                        <button class="bg-white text-caf-blue px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2">
                            Iniciar Rutina <i class="fas fa-play text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Schedule Card -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden relative click-scale cursor-pointer group" onclick="navigateTo('schedule')">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1571902943202-507ec2618e8f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60')] bg-cover bg-center opacity-20 group-hover:opacity-30 transition"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/90 to-blue-800/70"></div>
                    <div class="relative p-6 text-white">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-calendar-alt text-blue-300 text-xl"></i>
                            <h3 class="font-bold text-xl">Clases Grupales</h3>
                        </div>
                        <p class="text-sm text-gray-200 mb-4">Reserva Spinning, Rumba, Yoga y más.</p>
                        <button class="bg-white text-caf-blue px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2">
                            Ver Horarios <i class="fas fa-arrow-right text-xs"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Vitals -->
                    <div class="bg-caf-blue rounded-2xl p-4 text-white relative overflow-hidden click-scale cursor-pointer" onclick="navigateTo('vitals')">
                        <i class="fas fa-chart-line text-4xl text-white/10 absolute right-[-10px] bottom-[-10px]"></i>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-heartbeat text-pink-500"></i>
                            <span class="font-bold">Progreso</span>
                        </div>
                        <p class="text-xs text-gray-300 mb-3">Cargas y Salud</p>
                    </div>

                    <!-- Medic (Simulado) -->
                    <div class="bg-white rounded-2xl p-4 text-caf-blue shadow-sm relative overflow-hidden click-scale cursor-pointer" onclick="showToast('Módulo Medic próximamente...', 'gray')">
                        <i class="fas fa-user-md text-4xl text-gray-100 absolute right-[-10px] bottom-[-10px]"></i>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-hospital-user text-teal-500"></i>
                            <span class="font-bold">Médico</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Citas deportivas</p>
                    </div>
                </div>
            </div>

            <!-- VISTA 2: SCHEDULE (CLASES) -->
            <div id="view-schedule" class="hidden p-6 space-y-4 fade-in">
                <!-- Filtros de fecha -->
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <button class="px-4 py-2 bg-caf-blue text-white rounded-full text-sm font-bold whitespace-nowrap">Hoy</button>
                    <button class="px-4 py-2 bg-white text-gray-500 border border-gray-200 rounded-full text-sm font-medium whitespace-nowrap">Mañana</button>
                    <button class="px-4 py-2 bg-white text-gray-500 border border-gray-200 rounded-full text-sm font-medium whitespace-nowrap">Jueves 17</button>
                </div>

                <!-- Lista de Clases -->
                <div class="space-y-4">
                    <!-- Clase 1 -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-caf-blue flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-caf-blue">Spinning</h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="far fa-clock"></i> 10:00 AM - 11:00 AM</p>
                                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1"><i class="fas fa-map-marker-alt"></i> Pérgola Bienestar</p>
                            </div>
                            <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-md font-bold">15/20</span>
                        </div>
                        <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 bg-gray-200 rounded-full overflow-hidden">
                                    <img src="https://randomuser.me/api/portraits/men/32.jpg" class="w-full h-full object-cover">
                                </div>
                                <span class="text-xs font-medium text-gray-600">Alex Rodriguez</span>
                            </div>
                            <button class="bg-caf-blue text-white text-xs px-4 py-2 rounded-lg font-bold click-scale" onclick="reservarClase(this, 'Spinning')">Reservar</button>
                        </div>
                    </div>

                    <!-- Clase 2 -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-pink-500 flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-caf-blue">Rumba</h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="far fa-clock"></i> 16:00 PM - 17:30 PM</p>
                                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1"><i class="fas fa-map-marker-alt"></i> Salón Espejos</p>
                            </div>
                            <span class="bg-green-50 text-green-600 text-xs px-2 py-1 rounded-md font-bold">8/20</span>
                        </div>
                        <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 bg-gray-200 rounded-full overflow-hidden">
                                    <img src="https://randomuser.me/api/portraits/women/44.jpg" class="w-full h-full object-cover">
                                </div>
                                <span class="text-xs font-medium text-gray-600">Laura Clavijo</span>
                            </div>
                            <button class="bg-caf-blue text-white text-xs px-4 py-2 rounded-lg font-bold click-scale" onclick="reservarClase(this, 'Rumba')">Reservar</button>
                        </div>
                    </div>

                    <!-- Clase 3 -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-purple-500 flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-caf-blue">Yoga</h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="far fa-clock"></i> 18:00 PM - 19:00 PM</p>
                                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1"><i class="fas fa-map-marker-alt"></i> Zona Verde</p>
                            </div>
                            <span class="bg-red-50 text-red-600 text-xs px-2 py-1 rounded-md font-bold">Full</span>
                        </div>
                        <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 bg-gray-200 rounded-full overflow-hidden">
                                    <img src="https://randomuser.me/api/portraits/women/68.jpg" class="w-full h-full object-cover">
                                </div>
                                <span class="text-xs font-medium text-gray-600">Ana Maria</span>
                            </div>
                            <button class="bg-gray-300 text-white text-xs px-4 py-2 rounded-lg font-bold cursor-not-allowed" disabled>Lista de Espera</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA 3: TRAINING DASHBOARD (Categorías) -->
            <div id="view-training" class="hidden p-6 space-y-6 fade-in">
                
                <!-- INGRESO / LOCKER -->
                <div class="bg-white p-5 rounded-2xl shadow-md border border-blue-100">
                    <h3 class="font-bold text-caf-blue mb-4 flex items-center gap-2">
                        <i class="fas fa-door-open text-indigo-500"></i> Acceso al CAF
                    </h3>
                    <div id="lockerDisplay" class="hidden mb-4 transition-all duration-500">
                        <div class="locker-card assigned p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded-full shadow-sm text-green-600">
                                    <i class="fas fa-key text-xl"></i>
                                </div>
                                <div>
                                    <div class="text-xs font-bold text-green-800 uppercase">Locker Asignado</div>
                                    <div class="text-2xl font-bold text-green-900" id="lockerNumber">--</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-700 font-medium">Zona A</div>
                            </div>
                        </div>
                    </div>
                    <button id="checkInBtn" onclick="toggleCheckIn()" class="w-full py-4 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg shadow-lg shadow-green-200 click-scale flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-qrcode"></i> Check-in Entrada
                    </button>
                </div>

                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-caf-blue text-lg">Elige tu Rutina</h3>
                    <span class="text-xs text-gray-400">Nivel: Intermedio</span>
                </div>

                <!-- Grid de Rutinas -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm click-scale cursor-pointer hover:shadow-md transition border-b-4 border-blue-500" onclick="openRoutine('Pecho y Espalda')">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center mb-3 text-blue-600">
                            <i class="fas fa-user-shield text-lg"></i>
                        </div>
                        <h4 class="font-bold text-gray-800">Pecho y Espalda</h4>
                        <p class="text-xs text-gray-400 mt-1">6 Ejercicios</p>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm click-scale cursor-pointer hover:shadow-md transition border-b-4 border-purple-500" onclick="openRoutine('Pierna Completa')">
                        <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center mb-3 text-purple-600">
                            <i class="fas fa-running text-lg"></i>
                        </div>
                        <h4 class="font-bold text-gray-800">Pierna</h4>
                        <p class="text-xs text-gray-400 mt-1">5 Ejercicios</p>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm click-scale cursor-pointer hover:shadow-md transition border-b-4 border-orange-500" onclick="openRoutine('Brazos y Hombros')">
                        <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center mb-3 text-orange-600">
                            <i class="fas fa-fist-raised text-lg"></i>
                        </div>
                        <h4 class="font-bold text-gray-800">Brazo</h4>
                        <p class="text-xs text-gray-400 mt-1">4 Ejercicios</p>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm click-scale cursor-pointer hover:shadow-md transition border-b-4 border-green-500" onclick="openRoutine('Funcional')">
                        <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center mb-3 text-green-600">
                            <i class="fas fa-heartbeat text-lg"></i>
                        </div>
                        <h4 class="font-bold text-gray-800">Funcional</h4>
                        <p class="text-xs text-gray-400 mt-1">Circuito 30m</p>
                    </div>
                </div>
            </div>

            <!-- VISTA 4: DETALLE RUTINA (Active Workout) -->
            <div id="view-workout-detail" class="hidden p-6 pb-32 space-y-6 fade-in bg-white min-h-full">
                <div class="flex justify-between items-end border-b pb-4">
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Entrenamiento</p>
                        <h2 class="text-2xl font-bold text-caf-blue" id="routineTitle">Pecho y Espalda</h2>
                    </div>
                    <div class="bg-blue-50 px-3 py-1 rounded-full text-xs font-bold text-blue-600" id="routineExerciseCount">6 Ejercicios</div>
                </div>

                <!-- Contenedor dinámico de ejercicios -->
                <div id="exercisesContainer" class="space-y-6">
                    <!-- Los ejercicios se inyectan aquí con JS -->
                </div>

                <button onclick="finishWorkout()" class="w-full py-4 bg-caf-blue text-white rounded-xl font-bold shadow-lg click-scale mb-10">
                    <i class="fas fa-check-circle mr-2"></i> Finalizar Entrenamiento
                </button>
            </div>

            <!-- VISTA 5: VITALS (Salud + Progreso Cargas) -->
            <div id="view-vitals" class="hidden p-6 space-y-6 fade-in">
                <!-- Métricas Corporales -->
                <div class="bg-white p-6 rounded-2xl shadow-sm relative">
                    <h3 class="font-bold text-xl text-caf-blue mb-4">Métricas Corporales</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Peso</div>
                            <div class="text-lg font-bold text-gray-800">68 <span class="text-xs font-normal">kg</span></div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">BMI</div>
                            <div class="text-lg font-bold text-gray-800">22.2</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">% Grasa</div>
                            <div class="text-lg font-bold text-green-600">18.3%</div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico Progreso de Cargas (Nuevo) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-caf-blue flex items-center gap-2">
                            <i class="fas fa-chart-bar text-caf-accent"></i> Progreso de Cargas
                        </h3>
                        <select id="chartMetricSelect" class="text-xs bg-gray-100 border-none rounded px-2 py-1 text-gray-600" onchange="updateLoadChart()">
                            <option value="Press Plano">Press Plano</option>
                            <option value="Sentadilla">Sentadilla</option>
                            <option value="Peso Muerto">Peso Muerto</option>
                        </select>
                    </div>
                    <div class="relative h-48">
                        <canvas id="loadChart"></canvas>
                    </div>
                    <p class="text-xs text-gray-400 text-center mt-2">Registro de peso máximo (1RM estimado)</p>
                </div>

                <!-- Historial -->
                <div class="space-y-2">
                    <h3 class="font-bold text-sm text-gray-500 px-2">HISTORIAL DE ENTRENAMIENTOS</h3>
                    <div id="historyContainer">
                        <!-- Historial inyectado -->
                    </div>
                </div>
            </div>

        </div>

        <!-- TOAST NOTIFICACIONES -->
        <div id="toast-container" class="absolute bottom-24 left-0 right-0 px-6 pointer-events-none flex flex-col gap-2 items-center z-50"></div>

        <!-- NAVBAR -->
        <div class="bg-white border-t border-gray-100 p-4 flex justify-around items-center absolute bottom-0 w-full z-20 pb-6" id="navBar">
            <div class="nav-item text-caf-blue flex flex-col items-center cursor-pointer" onclick="navigateTo('home')" id="nav-home">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Inicio</span>
            </div>
            <div class="nav-item text-gray-400 flex flex-col items-center cursor-pointer" onclick="navigateTo('schedule')" id="nav-schedule">
                <i class="fas fa-calendar-day text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Agenda</span>
            </div>
            
            <div class="relative -top-6">
                <div class="bg-caf-accent text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-red-200 click-scale cursor-pointer border-4 border-gray-50" onclick="navigateTo('training')">
                    <i class="fas fa-dumbbell text-xl"></i>
                </div>
            </div>

            <div class="nav-item text-gray-400 flex flex-col items-center cursor-pointer" onclick="navigateTo('vitals')" id="nav-vitals">
                <i class="fas fa-heartbeat text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Salud</span>
            </div>
            <div class="nav-item text-gray-400 flex flex-col items-center cursor-pointer">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Perfil</span>
            </div>
        </div>

    </div>

    <script>
        // --- DATOS Y ESTADO ---
        let state = {
            checkedIn: false,
            currentView: 'home',
            workoutHistory: [],
            maxLoads: {
                'Press Plano': [40, 45, 45, 50],
                'Sentadilla': [60, 65, 70, 70],
                'Peso Muerto': [80, 85, 90, 95]
            },
            months: ['Ene', 'Feb', 'Mar', 'Abr']
        };

        const routinesDB = {
            'Pecho y Espalda': [
                { id: 'e1', name: 'Press Plano', sets: 4 },
                { id: 'e2', name: 'Remo con Barra', sets: 4 },
                { id: 'e3', name: 'Press Inclinado', sets: 3 },
                { id: 'e4', name: 'Jalón al Pecho', sets: 3 },
                { id: 'e5', name: 'Aperturas', sets: 3 },
                { id: 'e6', name: 'Pull-over', sets: 3 }
            ],
            'Pierna Completa': [
                { id: 'l1', name: 'Sentadilla', sets: 4 },
                { id: 'l2', name: 'Prensa', sets: 4 },
                { id: 'l3', name: 'Peso Muerto', sets: 4 },
                { id: 'l4', name: 'Extensiones', sets: 3 },
                { id: 'l5', name: 'Curl Femoral', sets: 3 }
            ],
            'Brazos y Hombros': [
                { id: 'a1', name: 'Press Militar', sets: 4 },
                { id: 'a2', name: 'Elevaciones Laterales', sets: 3 },
                { id: 'a3', name: 'Curl de Bíceps', sets: 4 },
                { id: 'a4', name: 'Extensión de Tríceps', sets: 4 }
            ],
            'Funcional': [
                { id: 'f1', name: 'Burpees', sets: 3 },
                { id: 'f2', name: 'Kettlebell Swing', sets: 3 },
                { id: 'f3', name: 'Box Jumps', sets: 3 }
            ]
        };

        // CONFIG FECHA
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES', dateOptions);

        // --- NAVEGACIÓN ---
        function navigateTo(viewId) {
            // Reset scroll
            document.getElementById('mainContent').scrollTop = 0;

            // Ocultar vistas
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            
            // Mostrar destino
            const target = document.getElementById(`view-${viewId}`);
            target.classList.remove('hidden');
            
            // UI Updates
            const backBtn = document.getElementById('backButton');
            const titles = {
                'home': 'Bienvenido al CAF',
                'schedule': 'Agenda de Clases',
                'training': 'Training Log',
                'workout-detail': 'Entrenando...',
                'vitals': 'Salud y Progreso'
            };
            
            document.getElementById('headerTitle').textContent = titles[viewId] || 'CAF';
            
            if(viewId === 'home') {
                backBtn.classList.add('hidden');
                document.getElementById('profileHeader').classList.remove('hidden');
            } else {
                backBtn.classList.remove('hidden');
                document.getElementById('profileHeader').classList.add('hidden');
            }

            // Nav Icons Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-caf-blue');
                el.classList.add('text-gray-400');
            });
            const activeIcon = document.getElementById(`nav-${viewId}`);
            if(activeIcon) {
                activeIcon.classList.remove('text-gray-400');
                activeIcon.classList.add('text-caf-blue');
            }

            // Render Charts si vamos a vitals
            if(viewId === 'vitals') {
                renderHistory();
                updateLoadChart();
            }
        }

        function goBack() {
            const current = document.querySelector('[id^="view-"]:not(.hidden)').id;
            if(current === 'view-workout-detail') navigateTo('training');
            else navigateTo('home');
        }

        // --- LÓGICA AGENDA (SCHEDULE) ---
        function reservarClase(btn, className) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.classList.remove('bg-caf-blue', 'text-white');
                btn.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
                btn.innerHTML = '<i class="fas fa-check"></i> Reservado';
                
                showToast(`Power Automate: Reserva para ${className} confirmada`, 'green');
                
                // Simulación de correo
                setTimeout(() => showToast('Outlook: Invitación añadida al calendario', 'blue'), 1500);
            }, 1500);
        }

        // --- LÓGICA ENTRENAMIENTO ---
        function toggleCheckIn() {
            const btn = document.getElementById('checkInBtn');
            const lockerDisplay = document.getElementById('lockerDisplay');
            const lockerNumEl = document.getElementById('lockerNumber');

            if (!state.checkedIn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando...';
                
                setTimeout(() => {
                    const randomLocker = Math.floor(Math.random() * 100) + 1;
                    lockerNumEl.textContent = `#${randomLocker}`;
                    state.checkedIn = true;
                    lockerDisplay.classList.remove('hidden');
                    
                    btn.className = "w-full py-4 rounded-xl bg-white border-2 border-red-500 text-red-500 font-bold text-lg click-scale flex items-center justify-center gap-2 transition-all";
                    btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Check-out Salida';
                    btn.disabled = false;

                    showToast('Power Automate: Locker asignado y torniquete abierto', 'green');
                }, 1200);
            } else {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                setTimeout(() => {
                    state.checkedIn = false;
                    lockerDisplay.classList.add('hidden');
                    
                    btn.className = "w-full py-4 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg shadow-lg shadow-green-200 click-scale flex items-center justify-center gap-2 transition-all";
                    btn.innerHTML = '<i class="fas fa-qrcode"></i> Check-in Entrada';
                    btn.disabled = false;

                    showToast('Dataverse: Salida registrada. ¡Buen entreno!', 'blue');
                }, 1200);
            }
        }

        function openRoutine(routineName) {
            const exercises = routinesDB[routineName];
            const container = document.getElementById('exercisesContainer');
            document.getElementById('routineTitle').textContent = routineName;
            document.getElementById('routineExerciseCount').textContent = `${exercises.length} Ejercicios`;
            
            container.innerHTML = '';
            
            exercises.forEach((ex, index) => {
                let setRows = '';
                for(let i=1; i<=ex.sets; i++) {
                    setRows += `
                        <div class="grid grid-cols-3 gap-2 mb-2 items-center">
                            <span class="text-xs text-gray-400 text-center">Set ${i}</span>
                            <input type="number" placeholder="kg" class="workout-input" id="w-${ex.name}-${i}">
                            <input type="number" placeholder="reps" class="workout-input" value="12">
                        </div>
                    `;
                }

                const html = `
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-caf-blue flex items-center gap-2">
                                <span class="bg-white w-6 h-6 rounded-full flex items-center justify-center text-xs border border-gray-200 shadow-sm">${index + 1}</span>
                                ${ex.name}
                            </h4>
                            <i class="fas fa-video text-gray-300"></i>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-2 text-xs font-bold text-gray-400 text-center">
                            <span>SET</span>
                            <span>PESO (KG)</span>
                            <span>REPS</span>
                        </div>
                        ${setRows}
                    </div>
                `;
                container.innerHTML += html;
            });

            navigateTo('workout-detail');
        }

        function finishWorkout() {
            showToast('Dataverse: Guardando registros...', 'blue');
            
            // Simular guardado de datos para Vitals
            // Buscar si se metió peso en Press Plano, Sentadilla o Peso Muerto
            ['Press Plano', 'Sentadilla', 'Peso Muerto'].forEach(exName => {
                const input = document.getElementById(`w-${exName}-1`);
                if(input && input.value) {
                    state.maxLoads[exName].push(parseInt(input.value));
                    if(state.maxLoads[exName].length > 5) state.maxLoads[exName].shift();
                } else if (routinesDB['Pecho y Espalda'].find(e => e.name === exName) && document.querySelector('[id^="w-Press Plano"]')) {
                     // Si está en la rutina pero no se llenó, solo repetimos ultimo valor para demo
                     const last = state.maxLoads[exName][state.maxLoads[exName].length-1];
                     state.maxLoads[exName].push(last);
                }
            });
            
            // Añadir mes ficticio si crece el array
            if(state.maxLoads['Press Plano'].length > state.months.length) {
                state.months.push('May');
            }

            setTimeout(() => {
                showToast('¡Entrenamiento guardado exitosamente!', 'green');
                // Añadir al historial visual
                const routineName = document.getElementById('routineTitle').textContent;
                state.workoutHistory.unshift({
                    name: routineName,
                    date: new Date().toLocaleDateString('es-ES', {day: 'numeric', month: 'short'}),
                    duration: '45 min'
                });
                
                navigateTo('training');
            }, 1500);
        }

        // --- LÓGICA VITALS (CHARTS) ---
        let loadChartInstance = null;

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            if(state.workoutHistory.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-xs text-gray-400 bg-gray-50 rounded-xl">No hay registros recientes</div>';
                return;
            }
            
            container.innerHTML = '';
            state.workoutHistory.forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-caf-blue mb-2">
                        <div>
                            <div class="text-sm font-bold text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-400"><i class="far fa-clock"></i> ${item.duration}</div>
                        </div>
                        <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">${item.date}</span>
                    </div>
                `;
            });
        }

        function updateLoadChart() {
            const exercise = document.getElementById('chartMetricSelect').value;
            const dataPoints = state.maxLoads[exercise];
            const ctx = document.getElementById('loadChart').getContext('2d');

            if(loadChartInstance) loadChartInstance.destroy();

            loadChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.months,
                    datasets: [{
                        label: 'Peso Máximo (kg)',
                        data: dataPoints,
                        borderColor: '#E63946',
                        backgroundColor: 'rgba(230, 57, 70, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#E63946',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- UTILIDADES ---
        function showToast(msg, color = 'blue') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                'blue': 'bg-caf-blue',
                'green': 'bg-green-600',
                'gray': 'bg-gray-700'
            };

            toast.className = `${colors[color]} text-white px-4 py-3 rounded-full shadow-lg text-xs font-semibold flex items-center gap-2 animate-bounce transition-all opacity-90`;
            toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>